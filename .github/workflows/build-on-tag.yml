name: Build on Tag

on:
  push:
    tags:
      - 'v*.*.*'  # 匹配 v1.0.0, v2.1.3 等格式的 tag
      - '*'       # 或匹配所有 tag

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout 代码
      uses: actions/checkout@v4
      with:
        submodules: recursive  # 如果有子模块需要递归获取
    
    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libboost-tools-dev
    
    - name: 设置 Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: 'latest'
        actions-cache-folder: 'emsdk-cache'
    
    - name: 验证 Emscripten 安装
      run: |
        emcc --version
        which emcc
        which b2 || which bjam
    
    - name: 构建 Release 版本
      run: |
        # b2 是新版本的 bjam 命令
        if command -v b2 &> /dev/null; then
          b2 -j$(nproc) js_client
        else
          bjam -j$(nproc) js_client
        fi
    
    - name: 收集构建产物
      run: |
        mkdir -p artifacts
        # 根据实际构建输出路径调整
        find . -name "*.wasm" -o -name "*.js" | grep -E "(js_client|rdp)" | while read file; do
          cp "$file" artifacts/
        done
        ls -la artifacts/
    
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: rdpclient-${{ github.ref_name }}
        path: artifacts/
        retention-days: 90
    
    - name: 创建 Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
